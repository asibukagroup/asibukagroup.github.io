export default {async fetch(request){const url=new URL(request.url),shouldInject=url.searchParams.get('function')==='komisi-asibuka-logistics',response=await fetch(request),contentType=response.headers.get("content-type")||"";if(!shouldInject||!contentType.includes("text/html"))return response;return new HTMLRewriter().on("body",new ScriptInjector()).transform(response)}};class ScriptInjector{element(element){element.append(`<script>(function(){const params=new URLSearchParams(window.location.search),id1=params.get('id1'),gid1=params.get('gid1'),id2=params.get('id2'),gid2=params.get('gid2'),title=params.get('title'),embedDetails=document.getElementById('EmbedDetails'),embedResult=document.getElementById('EmbedResult'),embedTitle=document.getElementById('EmbedTitle');if(title){document.title=title;if(embedTitle){embedTitle.textContent='';embedTitle.append(title)}}if(id1&&gid1&&embedDetails){const csvDetails='https://docs.google.com/spreadsheets/d/e/'+id1+'/pub?gid='+gid1+'&single=true&output=csv';fetch(csvDetails).then(res=>res.text()).then(csv=>{const rows=csv.trim().split('\n').map(r=>r.split(',')),table=document.createElement('table');rows.forEach((row,i)=>{const tr=document.createElement('tr');row.forEach(cell=>{const el=document.createElement(i===0?'th':'td');el.textContent=cell;tr.appendChild(el)});table.appendChild(tr)});embedDetails.innerHTML='';embedDetails.removeAttribute('hidden');embedDetails.appendChild(table)}).catch(err=>{embedDetails.textContent='Failed to load data.';console.error('CSV fetch error:',err)})}if(id2&&gid2&&embedResult){const csvResult='https://docs.google.com/spreadsheets/d/e/'+id2+'/pub?gid='+gid2+'&single=true&output=csv';fetch(csvResult).then(res=>res.text()).then(csv=>{const rows=csv.trim().split('\n').map(r=>r.split(',')),table=document.createElement('table');rows.forEach((row,i)=>{const tr=document.createElement('tr');row.forEach(cell=>{const el=document.createElement(i===0?'th':'td');el.textContent=cell;tr.appendChild(el)});table.appendChild(tr)});embedResult.innerHTML='';embedResult.removeAttribute('hidden');const heading=document.createElement('h2');heading.className='main-heading';heading.textContent='Detil Transaksi';embedResult.parentNode.insertBefore(heading,embedResult);embedResult.appendChild(table)}).catch(err=>{embedResult.textContent='Failed to load data.';embedResult.removeAttribute('hidden');console.error('CSV fetch error:',err)})}document.querySelectorAll('.hide-on-embed').forEach(el=>{el.remove()});if(window.history.replaceState){const cleanUrl=window.location.origin+window.location.pathname;window.history.replaceState({},title||'',cleanUrl)}})();</script>`,{html:true})}}}
